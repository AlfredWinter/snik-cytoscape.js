<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>loadGraphFromSparql.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-filter-Filter.html">Filter</a><ul class='methods'><li data-type='method'><a href="module-filter-Filter.html#setVisibility">setVisibility</a></li></ul></li><li><a href="module-property.Property.html">Property</a></li></ul><h3>Modules</h3><ul><li><a href="module-about.html">about</a></li><li><a href="module-button.html">button</a></li><li><a href="module-classuse.html">classuse</a><ul class='methods'><li data-type='method'><a href="module-classuse.html#~roleUse">roleUse</a></li></ul></li><li><a href="module-colorschemeday.html">colorschemeday</a></li><li><a href="module-contextmenu.html">contextmenu</a><ul class='methods'><li data-type='method'><a href="module-contextmenu.html#~registerMenu">registerMenu</a></li></ul></li><li><a href="module-download.html">download</a><ul class='methods'><li data-type='method'><a href="module-download.html#.downloadGraph">downloadGraph</a></li><li data-type='method'><a href="module-download.html#.downloadLayout">downloadLayout</a></li><li data-type='method'><a href="module-download.html#.downloadPng">downloadPng</a></li><li data-type='method'><a href="module-download.html#.downloadVisibleGraph">downloadVisibleGraph</a></li></ul></li><li><a href="module-file.html">file</a><ul class='methods'><li data-type='method'><a href="module-file.html#.addFileLoadEntries">addFileLoadEntries</a></li><li data-type='method'><a href="module-file.html#.loadGraph">loadGraph</a></li><li data-type='method'><a href="module-file.html#.loadLayout">loadLayout</a></li><li data-type='method'><a href="module-file.html#.readTextFile">readTextFile</a></li><li data-type='method'><a href="module-file.html#~addLoadEntry">addLoadEntry</a></li><li data-type='method'><a href="module-file.html#~uploadJson">uploadJson</a></li></ul></li><li><a href="module-filter.html">filter</a><ul class='methods'><li data-type='method'><a href="module-filter.html#~addFilterEntries">addFilterEntries</a></li></ul></li><li><a href="module-graph.html">graph</a><ul class='methods'><li data-type='method'><a href="module-graph.html#~getSource">getSource</a></li><li data-type='method'><a href="module-graph.html#~hideNodes">hideNodes</a></li><li data-type='method'><a href="module-graph.html#~highlightEdges">highlightEdges</a></li><li data-type='method'><a href="module-graph.html#~highlightNodes">highlightNodes</a></li><li data-type='method'><a href="module-graph.html#~initGraph">initGraph</a></li><li data-type='method'><a href="module-graph.html#~invert">invert</a></li><li data-type='method'><a href="module-graph.html#~resetStyle">resetStyle</a></li><li data-type='method'><a href="module-graph.html#~setSelectedNode">setSelectedNode</a></li><li data-type='method'><a href="module-graph.html#~setSource">setSource</a></li><li data-type='method'><a href="module-graph.html#~setStarMode">setStarMode</a></li><li data-type='method'><a href="module-graph.html#~setTarget">setTarget</a></li><li data-type='method'><a href="module-graph.html#~showDoubleStar">showDoubleStar</a></li><li data-type='method'><a href="module-graph.html#~showNodes">showNodes</a></li><li data-type='method'><a href="module-graph.html#~showPath">showPath</a></li><li data-type='method'><a href="module-graph.html#~showStar">showStar</a></li><li data-type='method'><a href="module-graph.html#~showStarPath">showStarPath</a></li><li data-type='method'><a href="module-graph.html#~showWorm">showWorm</a></li></ul></li><li><a href="module-layout.html">layout</a><ul class='methods'><li data-type='method'><a href="module-layout.html#.positions">positions</a></li><li data-type='method'><a href="module-layout.html#.presetLayout">presetLayout</a></li><li data-type='method'><a href="module-layout.html#.run">run</a></li><li data-type='method'><a href="module-layout.html#.runCached">runCached</a></li><li data-type='method'><a href="module-layout.html#~storageName">storageName</a></li></ul></li><li><a href="module-loadGraphFromSparql.html">loadGraphFromSparql</a></li><li><a href="module-log.html">log</a><ul class='methods'><li data-type='method'><a href="module-log.html#.debug">debug</a></li><li data-type='method'><a href="module-log.html#.error">error</a></li><li data-type='method'><a href="module-log.html#.info">info</a></li><li data-type='method'><a href="module-log.html#.trace">trace</a></li><li data-type='method'><a href="module-log.html#.warn">warn</a></li></ul></li><li><a href="module-lunr.html">lunr</a></li><li><a href="module-main.html">main</a></li><li><a href="module-menu.html">menu</a><ul class='methods'><li data-type='method'><a href="module-menu.html#~addLoadEntries">addLoadEntries</a></li></ul></li><li><a href="module-progress.html">progress</a><ul class='methods'><li data-type='method'><a href="module-progress.html#~progress">progress</a></li></ul></li><li><a href="module-property.html">property</a><ul class='methods'><li data-type='method'><a href="module-property.html#.possible">possible</a></li></ul></li><li><a href="module-rdf.html">rdf</a><ul class='methods'><li data-type='method'><a href="module-rdf.html#.sub">sub</a></li></ul></li><li><a href="module-rdfGraph.html">rdfGraph</a></li><li><a href="module-search.html">search</a><ul class='methods'><li data-type='method'><a href="module-search.html#.search">search</a></li><li data-type='method'><a href="module-search.html#~showSearch">showSearch</a></li></ul></li><li><a href="module-sparql.html">sparql</a><ul class='methods'><li data-type='method'><a href="module-sparql.html#.ask">ask</a></li><li data-type='method'><a href="module-sparql.html#.sparql">sparql</a></li></ul></li><li><a href="module-string.html">string</a><ul class='methods'><li data-type='method'><a href="module-string.html#.abbrv">abbrv</a></li></ul></li><li><a href="module-style.html">style</a></li><li><a href="module-timer.html">timer</a></li></ul><h3>Global</h3><ul><li><a href="global.html#browsercheck">browsercheck</a></li><li><a href="global.html#colorschemenight">colorschemenight</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">loadGraphFromSparql.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
Loads the graph from the SNIK SPARQL endpoint. No layouting. May use caching.
@module */
import * as sparql from "./sparql.js";
import * as log from "./log.js";
import * as rdfGraph from "./rdfGraph.js";
import timer from "./timer.js";

String.prototype.hashCode = function()
{
  var hash = 0, i = 0, len = this.length;
  while (i &lt; len)
  {
    hash  = ((hash &lt;&lt; 5) - hash + this.charCodeAt(i++)) &lt;&lt; 0;
  }
  return hash;
};

/** Loads a set of subontologies into the given graph. Data from RDF helper graphs is loaded as well, such as virtual triples.
@param{cytoscape} cy the cytoscape graph to load the data into
@param{Set} subs Set of subontologies to load.
@example
loadGraphFromSparql(cy,new Set(["meta","bb"]))
*/
export default function loadGraphFromSparql(cy,subs)
{
  const rdfGraphs = [...(new Set([...rdfGraph.helper(),...subs]))];
  const froms = rdfGraphs.map(sub=>`from &lt;http://www.snik.eu/ontology/${sub}>`).reduce((a,b)=>a+"\n"+b);
  cy.elements().remove();
  //file.load();
  // load graph from SPARQL endpoint instead of from the .cyjs file
  // only show classes with labels, use any one if more than one
  // degree too time consuming, remove for development
  const classQuery =
  `select ?c str(sample(?l)) as ?l replace(str(sample(?subTop)),".*[#/]","") as ?subTop replace(str(?source),".*[#/]","") as ?source sample(?instance) as ?instance
  #count(?o) as ?degree
  ${froms}
  {
    ?c a owl:Class.
    #{?c ?p ?o.} UNION {?o ?p ?c}.#too slow, remove isolated nodes in post processing
    OPTIONAL {?source ov:defines ?c.}
    OPTIONAL {?c meta:subTopClass ?subTop.}
    OPTIONAL {?c rdfs:label ?l.}
    OPTIONAL {?instance a ?c.}
  }`;
  const propertyQuery =
  `select ?c ?p ?d ?g
  ${froms}
  {
    owl:Class ^a ?c,?d.
    graph ?g {?c ?p ?d.}
    filter(?p!=meta:subTopClass)
  }`;
  const sparqlClassesTimer = timer("sparql-classes");
  let sparqlPropertiesTimer;
  const classes = undefined;//localStorage.getItem('classes');
  // if not in cache, load
  const classesPromise = (classes===undefined)?
    sparql.sparql(classQuery):Promise.resolve(classes);

  return classesPromise.then((json)=>
  {
    sparqlClassesTimer.stop(json.length+" classes");
    for(let i=0;i&lt;json.length;i++)
    {
      cy.add(
        {
          group: "nodes",
          data: {
            id: json[i].c.value,
            name: json[i].c.value,
            ld: [(json[i].l===undefined)?json[i].c.value:json[i].l.value],
            st: (json[i].subTop===undefined)?null:json[i].subTop.value,
            prefix: (json[i].source===undefined)?null:json[i].source.value,
            inst: json[i].instance!==undefined,
            //degree: parseInt(json[i].degree.value),
          },
          //position: { x: 200, y: 200 }
        });
      /*console.log(json[i].l);
        console.log(json[i].l.value);*/
    }
  }).then(()=>
  {
    sparqlPropertiesTimer = timer("sparql-properties");
    //const triplesPromise =
    // only show classes with labels, use any one if more than one
    //`select ?c replace(str(?p),".*[#/]","") as ?p ?d
    return sparql.sparql(propertyQuery);
  }).catch(e=>
  {
    log.error(classQuery,e);
    return;
  })
    .then(json=>
    //return Promise.all([classesAddedPromise,triplesPromise]).then((values)=>
    {
      sparqlPropertiesTimer.stop(json.length+" properties");
      for(let i=0;i&lt;json.length;i++)
      {
        cy.add(
          {
            group: "edges",
            data: {
              source: json[i].c.value,
              target: json[i].d.value,
              id: i,
              p: json[i].p.value,//Labels_DE: [json[i].l.value]
              pl: json[i].p.value.replace(/.*[#/]/,""),
              g:json[i].g.value,
            },
          //position: { x: 200, y: 200 }
          });
      }
      // remove isolated nodes (too costly in SPARQL query)
      // deactivated for now, so that isolated nodes can be found and fixed
      //cy.nodes("[[degree=0]]").remove();
      return cy;
    }).catch(e=>
    {
      log.error(e);
    });
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Feb 22 2018 22:23:13 GMT+0100 (CET) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
