<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>search.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-filter-Filter.html">Filter</a><ul class='methods'><li data-type='method'><a href="module-filter-Filter.html#setVisibility">setVisibility</a></li></ul></li><li><a href="module-property.Property.html">Property</a></li></ul><h3>Modules</h3><ul><li><a href="module-about.html">about</a></li><li><a href="module-button.html">button</a></li><li><a href="module-classuse.html">classuse</a><ul class='methods'><li data-type='method'><a href="module-classuse.html#~roleUse">roleUse</a></li></ul></li><li><a href="module-colorschemeday.html">colorschemeday</a></li><li><a href="module-contextmenu.html">contextmenu</a><ul class='methods'><li data-type='method'><a href="module-contextmenu.html#~registerMenu">registerMenu</a></li></ul></li><li><a href="module-download.html">download</a><ul class='methods'><li data-type='method'><a href="module-download.html#.downloadGraph">downloadGraph</a></li><li data-type='method'><a href="module-download.html#.downloadLayout">downloadLayout</a></li><li data-type='method'><a href="module-download.html#.downloadPng">downloadPng</a></li><li data-type='method'><a href="module-download.html#.downloadVisibleGraph">downloadVisibleGraph</a></li></ul></li><li><a href="module-file.html">file</a><ul class='methods'><li data-type='method'><a href="module-file.html#.addFileLoadEntries">addFileLoadEntries</a></li><li data-type='method'><a href="module-file.html#.loadGraph">loadGraph</a></li><li data-type='method'><a href="module-file.html#.loadLayout">loadLayout</a></li><li data-type='method'><a href="module-file.html#.readTextFile">readTextFile</a></li><li data-type='method'><a href="module-file.html#~addLoadEntry">addLoadEntry</a></li><li data-type='method'><a href="module-file.html#~uploadJson">uploadJson</a></li></ul></li><li><a href="module-filter.html">filter</a><ul class='methods'><li data-type='method'><a href="module-filter.html#~addFilterEntries">addFilterEntries</a></li></ul></li><li><a href="module-graph.html">graph</a><ul class='methods'><li data-type='method'><a href="module-graph.html#~getSource">getSource</a></li><li data-type='method'><a href="module-graph.html#~hideNodes">hideNodes</a></li><li data-type='method'><a href="module-graph.html#~highlightEdges">highlightEdges</a></li><li data-type='method'><a href="module-graph.html#~highlightNodes">highlightNodes</a></li><li data-type='method'><a href="module-graph.html#~initGraph">initGraph</a></li><li data-type='method'><a href="module-graph.html#~invert">invert</a></li><li data-type='method'><a href="module-graph.html#~resetStyle">resetStyle</a></li><li data-type='method'><a href="module-graph.html#~setSelectedNode">setSelectedNode</a></li><li data-type='method'><a href="module-graph.html#~setSource">setSource</a></li><li data-type='method'><a href="module-graph.html#~setStarMode">setStarMode</a></li><li data-type='method'><a href="module-graph.html#~setTarget">setTarget</a></li><li data-type='method'><a href="module-graph.html#~showDoubleStar">showDoubleStar</a></li><li data-type='method'><a href="module-graph.html#~showNodes">showNodes</a></li><li data-type='method'><a href="module-graph.html#~showPath">showPath</a></li><li data-type='method'><a href="module-graph.html#~showStar">showStar</a></li><li data-type='method'><a href="module-graph.html#~showStarPath">showStarPath</a></li><li data-type='method'><a href="module-graph.html#~showWorm">showWorm</a></li></ul></li><li><a href="module-layout.html">layout</a><ul class='methods'><li data-type='method'><a href="module-layout.html#.positions">positions</a></li><li data-type='method'><a href="module-layout.html#.presetLayout">presetLayout</a></li><li data-type='method'><a href="module-layout.html#.run">run</a></li><li data-type='method'><a href="module-layout.html#.runCached">runCached</a></li><li data-type='method'><a href="module-layout.html#~storageName">storageName</a></li></ul></li><li><a href="module-loadGraphFromSparql.html">loadGraphFromSparql</a></li><li><a href="module-log.html">log</a><ul class='methods'><li data-type='method'><a href="module-log.html#.debug">debug</a></li><li data-type='method'><a href="module-log.html#.error">error</a></li><li data-type='method'><a href="module-log.html#.info">info</a></li><li data-type='method'><a href="module-log.html#.trace">trace</a></li><li data-type='method'><a href="module-log.html#.warn">warn</a></li></ul></li><li><a href="module-lunr.html">lunr</a></li><li><a href="module-main.html">main</a></li><li><a href="module-menu.html">menu</a><ul class='methods'><li data-type='method'><a href="module-menu.html#~addLoadEntries">addLoadEntries</a></li></ul></li><li><a href="module-progress.html">progress</a><ul class='methods'><li data-type='method'><a href="module-progress.html#~progress">progress</a></li></ul></li><li><a href="module-property.html">property</a><ul class='methods'><li data-type='method'><a href="module-property.html#.possible">possible</a></li></ul></li><li><a href="module-rdf.html">rdf</a><ul class='methods'><li data-type='method'><a href="module-rdf.html#.sub">sub</a></li></ul></li><li><a href="module-rdfGraph.html">rdfGraph</a></li><li><a href="module-search.html">search</a><ul class='methods'><li data-type='method'><a href="module-search.html#.search">search</a></li><li data-type='method'><a href="module-search.html#~showSearch">showSearch</a></li></ul></li><li><a href="module-sparql.html">sparql</a><ul class='methods'><li data-type='method'><a href="module-sparql.html#.ask">ask</a></li><li data-type='method'><a href="module-sparql.html#.sparql">sparql</a></li></ul></li><li><a href="module-string.html">string</a><ul class='methods'><li data-type='method'><a href="module-string.html#.abbrv">abbrv</a></li></ul></li><li><a href="module-style.html">style</a></li><li><a href="module-timer.html">timer</a></li></ul><h3>Global</h3><ul><li><a href="global.html#browsercheck">browsercheck</a></li><li><a href="global.html#colorschemenight">colorschemenight</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">search.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
Textual node search.
@module */
import * as graph from "./graph.js";
import * as sparql from "./sparql.js";
import * as log from "./log.js";

const USE_BIF_CONTAINS = false; // disable bif:contains search because it does not even accept all non-space strings and the performance hit is negliglible
var firstCumulativeSearch = true;

export function hideSearchResults()
{
  document.getElementById("overlay").style.width = "0%";
  document.getElementById("overlay").display = "none";
}

function createFailDialog(title, text,/*uri*/)
{
  log.error(`${title}: ${text}`);
  //alert(`${title}: ${text}`);
  /*
  return document.createDocumentFragment("&lt;div class='dialog' title='" + title + "'>&lt;p>" + text + "&lt;/p>&lt;/div>")
    .dialog({
      resizable: false,
      height:240,
      width:600,
      modal: true,
      buttons: {
        "Browse on LodView": function()
        {
          window.open(uri);
          $(this).dialog("close");
        },
        "LodLive": function()
        {
          window.open('http://en.lodlive.it/?'+uri);
          $(this).dialog("close");
        },
        "Close": function()
        {
          $(this).dialog("close");
        },
      },
    });
    */
}

// When user selects a URI from the search candidates, this URI gets centered and highlighted.
function presentUri(uri)
{
  graph.cy.zoom(0.6);
  var nodes = graph.cy.elements().nodes().filter(`node[name= "${uri}"]`);
  if(nodes.length&lt;1)
  {
    //alert(uri+' is only available on the SPARQL endpoint but not in the graph.');
    createFailDialog("Class not in graph",uri+' is only available on the SPARQL endpoint but not in the graph.',uri);
    //return false;
  }
  else
  {
    var node = nodes[0];
    if(document.getElementById('cumulativesearch').checked)
    {
      if(firstCumulativeSearch)
      {
        firstCumulativeSearch=false;
        graph.hideNodes(graph.cy.elements().nodes());
      }
    }
    else
    {
      graph.resetStyle();
    }
  }
  //graph.setSelectedNode(node);
  graph.highlightNodes(nodes);
  hideSearchResults();
  graph.cy.center(node);
}

var resultNodes = [];

function presentAll()
{
  if(resultNodes.length&lt;1)
  {
    hideSearchResults();
    alert("All search results are only available on the SPARQL endpoint but not in the graph.");
    return false;
  }
  hideSearchResults();
  if(document.getElementById('cumulativesearch').checked)
  {
    if(firstCumulativeSearch)
    {
      firstCumulativeSearch=false;
      graph.hideNodes(graph.cy.elements().nodes());
    }
  }
  else
  {
    graph.resetStyle();
    firstCumulativeSearch=true;
  }
  graph.highlightNodes(resultNodes,30);
  graph.cy.fit(resultNodes);
}

function showSearchResults(query, uris)
{
  resultNodes = [];
  var table = document.getElementById("tab:searchresults");
  for(var i = 0; i &lt; table.rows.length;)
  {
    table.deleteRow(i);
  }
  document.getElementById("overlay").display = "block";
  document.getElementById("overlay").style.width = "100%";
  if(uris.size===0)
  {
    document.getElementById("h2:searchresults").innerHTML=`No Search Results for "${query}"`;
    return false;
  }
  if(uris.size===1)
  {
    presentUri([...uris][0]);
    return true;
  }
  if(uris.size===sparql.SPARQL_LIMIT)
  {
    document.getElementById("h2:searchresults").innerHTML=`First ${sparql.SPARQL_LIMIT} Search Results for "${query}"`;
  }
  else
  {
    document.getElementById("h2:searchresults").innerHTML=`${uris.size} Search Results for "${query}"`;
  }
  uris.forEach(uri=>
  {
    var row = table.insertRow();
    var cell = row.insertCell(0);
    window.presentUri=presentUri;
    cell.innerHTML = `&lt;a href="javascript:window.presentUri('${uri}');void(0)">
		${uri.replace(sparql.SPARQL_PREFIX,"")}&lt;/a>`;
  });

  var row = table.insertRow(0);
  var cell = row.insertCell(0);
  window.presentAll=presentAll;
  cell.innerHTML = `&lt;a href="javascript:window.presentAll();void(0)">
		Highlight All&lt;/a>`;

  resultNodes = graph.cy.elements().nodes().filter((node)=>
  {
    return uris.has(node.data("name"));
  });
}

/** Searches the SPARQL endpoint for classes with the given label.
Case and space insensitive when not using bif:contains. Can be used by node.js. */
export function search(userQuery)
{
  // prevent invalid SPARQL query and injection by just alphanumeric characters
  var searchQuery = userQuery.replace(/[^A-Za-zäöüÄÖÜßéèôáà0-9]/g, ''); //.split(' ')[0];
  // use this when labels are available
  let sparqlQuery;
  if(!USE_BIF_CONTAINS||searchQuery.includes(' ')) // regex is slower but we have no choice with a space
  {
    sparqlQuery = `select distinct(?s) { {?s a owl:Class.} UNION {?s a rdf:Property.}
			{?s rdfs:label ?l.} UNION {?s skos:altLabel ?l.}	filter(regex(replace(str(?l)," ",""),"${searchQuery}","i")) } limit ${sparql.SPARQL_LIMIT}`;
  }
  else // no space so we can use the faster bif:contains
  {
    sparqlQuery = `select distinct(?s) { {?s a owl:Class.} UNION {?s a rdf:Property.}
			{?s rdfs:label ?l.		?l &lt;bif:contains> "${searchQuery}".} UNION
			{?s skos:altLabel ?l.	?l &lt;bif:contains> "${searchQuery}".}} limit ${sparql.SPARQL_LIMIT}`;
  }
  log.debug(sparqlQuery);
  return sparql.sparql(sparqlQuery).then(bindings=>new Set(bindings.map(b=>b.s.value)));
  //		`select ?s {{?s a owl:Class.} UNION {?s a rdf:Property.}.
  //filter (regex(replace(replace(str(?s),"${SPARQL_PREFIX}",""),"_"," "),"${query}","i")).}
}
/**Search the class labels and display the result to the user. */
function showSearch(userQuery)
{
  document.getElementById("overlay").style.display= "block";
  search(userQuery).then(uris =>
  {
    showSearchResults(userQuery,uris);
  });
  return false; // prevent page reload triggered by submit
}

export function addSearch()
{
  document.getElementById('closelink').addEventListener("click", hideSearchResults);
  document.getElementById("search").addEventListener("submit",(event)=>
  {
    event.preventDefault();
    hideSearchResults();
    showSearch(event.target.children.query.value);
  });
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Feb 22 2018 22:23:13 GMT+0100 (CET) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
