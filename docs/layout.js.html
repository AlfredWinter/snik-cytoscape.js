<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>layout.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-filter-Filter.html">Filter</a><ul class='methods'><li data-type='method'><a href="module-filter-Filter.html#setVisibility">setVisibility</a></li></ul></li><li><a href="module-property.Property.html">Property</a></li></ul><h3>Modules</h3><ul><li><a href="module-about.html">about</a></li><li><a href="module-button.html">button</a></li><li><a href="module-classuse.html">classuse</a><ul class='methods'><li data-type='method'><a href="module-classuse.html#~roleUse">roleUse</a></li></ul></li><li><a href="module-colorschemeday.html">colorschemeday</a></li><li><a href="module-contextmenu.html">contextmenu</a><ul class='methods'><li data-type='method'><a href="module-contextmenu.html#~registerMenu">registerMenu</a></li></ul></li><li><a href="module-download.html">download</a><ul class='methods'><li data-type='method'><a href="module-download.html#.downloadGraph">downloadGraph</a></li><li data-type='method'><a href="module-download.html#.downloadLayout">downloadLayout</a></li><li data-type='method'><a href="module-download.html#.downloadPng">downloadPng</a></li><li data-type='method'><a href="module-download.html#.downloadVisibleGraph">downloadVisibleGraph</a></li></ul></li><li><a href="module-file.html">file</a><ul class='methods'><li data-type='method'><a href="module-file.html#.addFileLoadEntries">addFileLoadEntries</a></li><li data-type='method'><a href="module-file.html#.loadGraph">loadGraph</a></li><li data-type='method'><a href="module-file.html#.loadLayout">loadLayout</a></li><li data-type='method'><a href="module-file.html#.readTextFile">readTextFile</a></li><li data-type='method'><a href="module-file.html#~addLoadEntry">addLoadEntry</a></li><li data-type='method'><a href="module-file.html#~uploadJson">uploadJson</a></li></ul></li><li><a href="module-filter.html">filter</a><ul class='methods'><li data-type='method'><a href="module-filter.html#~addFilterEntries">addFilterEntries</a></li></ul></li><li><a href="module-graph.html">graph</a><ul class='methods'><li data-type='method'><a href="module-graph.html#~getSource">getSource</a></li><li data-type='method'><a href="module-graph.html#~hideNodes">hideNodes</a></li><li data-type='method'><a href="module-graph.html#~highlightEdges">highlightEdges</a></li><li data-type='method'><a href="module-graph.html#~highlightNodes">highlightNodes</a></li><li data-type='method'><a href="module-graph.html#~initGraph">initGraph</a></li><li data-type='method'><a href="module-graph.html#~invert">invert</a></li><li data-type='method'><a href="module-graph.html#~resetStyle">resetStyle</a></li><li data-type='method'><a href="module-graph.html#~setSelectedNode">setSelectedNode</a></li><li data-type='method'><a href="module-graph.html#~setSource">setSource</a></li><li data-type='method'><a href="module-graph.html#~setStarMode">setStarMode</a></li><li data-type='method'><a href="module-graph.html#~setTarget">setTarget</a></li><li data-type='method'><a href="module-graph.html#~showDoubleStar">showDoubleStar</a></li><li data-type='method'><a href="module-graph.html#~showNodes">showNodes</a></li><li data-type='method'><a href="module-graph.html#~showPath">showPath</a></li><li data-type='method'><a href="module-graph.html#~showStar">showStar</a></li><li data-type='method'><a href="module-graph.html#~showStarPath">showStarPath</a></li><li data-type='method'><a href="module-graph.html#~showWorm">showWorm</a></li></ul></li><li><a href="module-layout.html">layout</a><ul class='methods'><li data-type='method'><a href="module-layout.html#.positions">positions</a></li><li data-type='method'><a href="module-layout.html#.presetLayout">presetLayout</a></li><li data-type='method'><a href="module-layout.html#.run">run</a></li><li data-type='method'><a href="module-layout.html#.runCached">runCached</a></li><li data-type='method'><a href="module-layout.html#~storageName">storageName</a></li></ul></li><li><a href="module-loadGraphFromSparql.html">loadGraphFromSparql</a></li><li><a href="module-log.html">log</a><ul class='methods'><li data-type='method'><a href="module-log.html#.debug">debug</a></li><li data-type='method'><a href="module-log.html#.error">error</a></li><li data-type='method'><a href="module-log.html#.info">info</a></li><li data-type='method'><a href="module-log.html#.trace">trace</a></li><li data-type='method'><a href="module-log.html#.warn">warn</a></li></ul></li><li><a href="module-lunr.html">lunr</a></li><li><a href="module-main.html">main</a></li><li><a href="module-menu.html">menu</a><ul class='methods'><li data-type='method'><a href="module-menu.html#~addLoadEntries">addLoadEntries</a></li></ul></li><li><a href="module-progress.html">progress</a><ul class='methods'><li data-type='method'><a href="module-progress.html#~progress">progress</a></li></ul></li><li><a href="module-property.html">property</a><ul class='methods'><li data-type='method'><a href="module-property.html#.possible">possible</a></li></ul></li><li><a href="module-rdf.html">rdf</a><ul class='methods'><li data-type='method'><a href="module-rdf.html#.sub">sub</a></li></ul></li><li><a href="module-rdfGraph.html">rdfGraph</a></li><li><a href="module-search.html">search</a><ul class='methods'><li data-type='method'><a href="module-search.html#.search">search</a></li><li data-type='method'><a href="module-search.html#~showSearch">showSearch</a></li></ul></li><li><a href="module-sparql.html">sparql</a><ul class='methods'><li data-type='method'><a href="module-sparql.html#.ask">ask</a></li><li data-type='method'><a href="module-sparql.html#.sparql">sparql</a></li></ul></li><li><a href="module-string.html">string</a><ul class='methods'><li data-type='method'><a href="module-string.html#.abbrv">abbrv</a></li></ul></li><li><a href="module-style.html">style</a></li><li><a href="module-timer.html">timer</a></li></ul><h3>Global</h3><ul><li><a href="global.html#browsercheck">browsercheck</a></li><li><a href="global.html#colorschemenight">colorschemenight</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">layout.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
Due to JavaScript being a slow mostly single-threaded language with no really fast layouting library available, layouting the full 4000+ node graph can take a minute or more depending on the client PC.
After the first time, the layout is cached and reused, until major changes occur in the graph.
If a breakthrough occurs in JavaScript graph layouting, update here and possibly remove cache. 
@module */
import * as log from "./log.js";
import timer from "./timer.js";
import * as rdfGraph from "./rdfGraph.js";
import * as file from "./file.js";

var activeLayout = undefined;

/**
@param {string} layoutName Cytoscape.js layout name
@param {Set} subs the subontology identifiers included in the graph. Used to retrieve the correct layout later.
@returns the storage name coded by the layout and the subontologies
@example storageName("euler",new Set(["meta","ob","bb"]));
*/
function storageName(layoutName,subs) {return "layout"+layoutName+[...subs].sort().toString().replace(/[^a-z]/g,"");}

/** Returns an array containing the positions of the given nodes
@param {cy.collection} nodes the nodes whose positions are returned
@returns an array containing the positions of the given nodes
@example
// returns [["http://www.snik.eu...",{"x":0,"y":0}],...]
positions(cy.nodes());
*/
export function positions(nodes)
{
  const pos=[];
  for(let i=0;i&lt;nodes.size();i++)
  {
    const node = nodes[i];
    pos.push([node.data().id,node.position()]);
  }
  return pos;
}

/** Layouts all visible nodes in a graph. Saves to cache but doesn't load from it (use {@link module:layout.runCached} for that).
@param {cy.cytoscape} cy the Cytoscape.js graph to run the layout on
@param {json} layoutConfig the layout configuration, which includes the layout name and options
@param {Set} subs Set of subontologies. If the subs are not given the layout still works but it is not cached.
@returns whether the layout could successfully be applied. Does not indicate success of saving to cache.
@example
run(cy,{"name":"grid"},new Set(["meta","ciox"]))
*/
export function run(cy,layoutConfig,subs)
{
  if(cy.nodes().size()===0)
  {
    log.warn("layout.js#run: Graph empty. Nothing to layout.");
    return false;
  }
  const layoutTimer = timer("layout");
  if(activeLayout) {activeLayout.stop();}
  activeLayout = cy.elements(":visible").layout(layoutConfig);
  activeLayout.run();
  layoutTimer.stop();
  if(subs)
  {
    if(typeof(localStorage)=== "undefined")
    {
      log.error("web storage not available, could not write to cache.");
      return true;
    }
    const pos=positions(cy.nodes());
    const name = storageName(layoutConfig.name,subs);
    localStorage.setItem(name,JSON.stringify(pos));
  }
  return true;
}

/** Applies a preset layout matching the node id's to the first element of each subarray in pos. Nodes without matching entry
in pos are set to position {x:0,y:0}, positions without matching node id are ignored.
@param {cytoscape} cy the Cytoscape.js graph to apply the positions on, node id's need to match those in the given positions
@param {array} pos an array of arrays, each of which contains the positions for a node id
@returns whether the layout could be successfully applied
@example
presetLayout(cy,[["http://www.snik.eu...",{"x":0,"y":0}],...]);
*/
export function presetLayout(cy,pos)
{
  const map = new Map(pos);
  let hits = 0;
  let misses = 0;
  const layoutConfig =
  {
    name: 'preset',
    fit:false,
    positions: node=>
    {
      let position;
      if((position= map.get(node._private.data.id)))
      {
        hits++;
        return position;
      }
      misses++;
      return {x:0,y:0};
    },
  };
  const status = run(cy,layoutConfig);
  if(misses>0||hits&lt;positions.length)
  {
    log.warn(`...${hits}/${cy.nodes().size()} node positions set. ${pos.length-hits} superfluous layout positions .`);
    const precision = hits/pos.length;
    const recall = hits/cy.nodes().size();
    if(precision&lt;config.layoutCacheMinPrecision)
    {
      log.warn(`Precision of ${precision} less than minimal required precision of ${config.layoutCacheMinPrecision}.`);
      return false;
    }
    if(recall&lt;config.layoutCacheMinRecall)
    {
      log.warn(`Recall of ${recall} less than minimal required of recall of ${config.layoutCacheMinRecall}.`);
      return false;
    }
  }
  else
  {
    log.debug("...layout applied with 100% overlap.");
  }
  if(hits===0) {return false;}
  return status;
}

/** Cached version of {@link module:layout.run}.
@param {cy.cytoscape} cy the Cytoscape.js graph to run the layout on
@param {json} layoutConfig the layout configuration, which includes the layout name and options
@param {Set} subs Set of subontologies. If the subs are not given the layout still works but it is not cached.
@returns whether the layout could successfully be applied. Does not indicate success of loading from cache,
in which case it is calculated anew.
*/
export function runCached(cy,layoutConfig,subs)
{
  if(typeof(localStorage)=== "undefined")
  {
    log.error("Web storage not available, could not access browser-based cache.");
    run(layoutConfig);
    return;
  }
  const name = storageName(layoutConfig.name,subs);
  // web storage
  const cacheItem = localStorage.getItem(name);
  // file
  /*
  if(!cacheItem)
  {
  log.warn("Web storage cache miss, trying to load from file...");
  file.readTextFile("cache/"+storageName)
  .then(text=>
  {
  cacheItem = text;
})
.catch(e=>{log.warn("File cache miss.");});
}
*/
  if(cacheItem) // cache hit
  {
    try
    {
      const pos=JSON.parse(cacheItem);
      log.info(`Loaded layout from cache, applying ${pos.length} positions...`);
      const status = presetLayout(cy,pos);
      if(status) {return true;}
      log.warn("Could not apply layout to active graph, recalculating layout...");
    }
    catch(e)
    {
      log.error("Could not load cache item, recalculating layout...",e);
    }
  }
  else // cache miss
  {
    log.warn("Layout not in cache, recalculating layout...");
  }
  return run(cy,layoutConfig,subs);
}

/** Very fast but useless for most purposes except for testing.*/
export var grid = {name: "grid"};

/**Fastest (but still slow) force directed Cytoscape.js layout found.*/
export var euler =
{
  /*eslint no-unused-vars: "off"*/
  name: "euler",
  springLength: edge => 200,
  maxSimulationTime: 2000,
  randomize: true,
  fit:false,
  mass: node => 40,
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Feb 22 2018 22:23:13 GMT+0100 (CET) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
